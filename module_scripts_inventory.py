# -*- coding: UTF-8 -*-

from header_common import *
from header_operations import *
from module_constants import *
from header_parties import *
from header_skills import *
from header_mission_templates import *
from header_items import *
from header_triggers import *
from header_terrain_types import *
from header_music import *
from header_map_icons import *
from header_presentations import *
from ID_animations import *
from ID_troops import *
from ID_factions import *
from module_troops import *

from module_scripts import *

inventory_scripts = [

#0, 1 are remained slot, 2, 3 are two ammo, 4567 are head, body, hand and foot, 8 are horse, 9 are food, 10, 11, 12 are right hand, 13, 14, 15 are left hand, 16, 17, 18, 19 are accessories, 20, 21, 22, 23 are small props

#small tool
#replace the former operation troop_get_inventory_capacity, only used by player
#output inventory capacity
  ("player_get_new_inventory_capacity", 
  [
    (store_skill_level, ":inventory_management_level", skl_inventory_management, "trp_player"),
    (assign, ":inventory_capacity", 50),
    (val_mul, ":inventory_management_level", 15),#50+level*15
    (val_add, ":inventory_capacity", ":inventory_management_level"),
    (assign, reg0, ":inventory_capacity"),
  ]),


#small tool
#replace the former operation troop_get_inventory_slot, only used by player. When the inventory slot is smaller then the ture capacity of player inventory, this two are the same.
#input slot no
#output item no. When this slot have no item, output -1; When the input is out of the capacity, output -2.
  ("player_get_new_inventory_slot", 
  [
    (store_script_param, ":slot_no", 1),
    (assign, ":item_no", -2),

    (call_script, "script_player_get_new_inventory_capacity"),
    (assign, ":player_capacity", reg0),
    (try_begin),
       (lt, ":slot_no", ":player_capacity"),#slot no begin from 0
       (assign, ":item_no", -1),
    (try_end),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (eq, ":item_no", -1),
       (lt, ":slot_no", ":original_inventory"),
       (troop_get_inventory_slot, ":item_no", "trp_player", ":slot_no"),
    (else_try),
       (eq, ":item_no", -1),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_get_inventory_slot, ":item_no", "trp_player_additional_inventory_1", ":slot_no"),
    (else_try),
       (eq, ":item_no", -1),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_get_inventory_slot, ":item_no", "trp_player_additional_inventory_2", ":slot_no"),
    (try_end),

    (assign, reg0, ":item_no"),
  ]),


#small tool
#替代troop_set_inventory_slot直接往玩家的指定槽里添加物品，不过当这个槽序号小于玩家实际物品栏时，这两个一个样。
#input slot no and item no
  ("player_set_new_inventory_slot", 
  [
    (store_script_param, ":slot_no", 1),
    (store_script_param, ":item_no", 2),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (lt, ":slot_no", ":original_inventory"),
       (troop_set_inventory_slot, "trp_player", ":slot_no", ":item_no"),
    (else_try),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_set_inventory_slot, "trp_player_additional_inventory_1", ":slot_no", ":item_no"),
    (else_try),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_set_inventory_slot, "trp_player_additional_inventory_2", ":slot_no", ":item_no"),
    (try_end),
  ]),


#small tool
#remove certain item when inventory slot is confirmed, only uesd for player. Npcs can use troop_set_inventory_slot directly.
#input slot no
  ("player_remove_new_inventory_slot", 
  [
    (store_script_param, ":slot_no", 1),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (lt, ":slot_no", ":original_inventory"),
       (troop_set_inventory_slot, "trp_player", ":slot_no", -1),
    (else_try),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_set_inventory_slot, "trp_player_additional_inventory_1", ":slot_no", -1),
    (else_try),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_set_inventory_slot, "trp_player_additional_inventory_2", ":slot_no", -1),
    (try_end),
  ]),


##new modifier system will have ai most three modifiers, and strings no will be use to indicate that. As modifier related string wont have a number more then 10000, the digital store will have a 10000 jump. When a modifier has a number less and equal than 42(begin form 0), it will be directly used on item, for it is an original modifier. This previous modifier can only be had one by each item, or former modifier will be covered by the next.

#small tool
#replace the former operation troop_get_inventory_slot_modifier
#input troop no and slot no
#output modifier no. There will be at most three modifiers, and take up reg0, reg1, reg2 respectively. When there is no three modifier, some reg will be zero.
  ("troop_get_new_inventory_slot_modifier", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":slot_no", 2),
    (assign, reg0, 0),
    (assign, reg1, 0),
    (assign, reg2, 0),
    (store_add, ":inventory_modifier_slot_no", ":slot_no", 1201),#slot no begin from 0
    (troop_get_slot, ":modifier_no", ":troop_no", ":inventory_modifier_slot_no"),
    (store_mod, ":modifier_1", ":modifier_no", 10000),
    (val_sub, ":modifier_no", ":modifier_1"),
    (store_mod, ":modifier_2", ":modifier_no", 100000000),
    (val_sub, ":modifier_no", ":modifier_2"),
    (store_div, ":modifier_3", ":modifier_no", 100000000),

    (try_begin),
       (try_begin),
          (eq, ":troop_no", "trp_player"),
          (call_script, "script_player_get_original_inventory_slot_modifier", ":slot_no"),
          (assign, ":original_modifier_no", reg0),
       (else_try),
          (troop_get_inventory_slot_modifier, ":original_modifier_no", ":troop_no", ":slot_no"),
       (try_end),
       (gt, ":original_modifier_no", 0),
       (val_add, ":original_modifier_no", "itm_imod_0"),
       (neq, ":modifier_1", ":original_modifier_no"),
       (neq, ":modifier_2", ":original_modifier_no"),
       (neq, ":modifier_3", ":original_modifier_no"),
       (call_script, "script_troop_set_new_inventory_slot_modifier_replace", ":troop_no", ":slot_no", ":original_modifier_no"),
       (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":slot_no"),
       (assign, ":modifier_1", reg0),
       (assign, ":modifier_2", reg1),
       (assign, ":modifier_3", reg2),
    (try_end),

    (assign, reg0, ":modifier_1"),
    (assign, reg1, ":modifier_2"),
    (assign, reg2, ":modifier_3"),
  ]),


#small tool
#replace the former operation troop_set_inventory_slot_modifier
#input troop no, slot no and modifier no. As there will be three modifier, when using this script, modifier will be automatically store in the smallest position. When there is no empty position, replace the last one.
  ("troop_set_new_inventory_slot_modifier_replace", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":slot_no", 2),    #inventory slot no
    (store_script_param, ":modifier_no", 3),
    (store_add, ":inventory_modifier_slot_no", ":slot_no", 1201),#slot no begin from 0
    (troop_get_slot, ":original_modifier_no", ":troop_no", ":inventory_modifier_slot_no"),
    (try_begin),
       (lt, ":original_modifier_no", 0),
       (assign, ":original_modifier_no", 0),
    (try_end),
    (assign, ":computed_original_modifier_no", ":original_modifier_no"),
    (try_begin),
       (store_mod, ":return_value", ":computed_original_modifier_no", 10000),
       (le, ":return_value", 0),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (val_sub, ":computed_original_modifier_no", ":return_value"),
       (store_mod, ":return_value", ":computed_original_modifier_no", 100000000),
       (le, ":return_value", 0),
       (val_mul, ":modifier_no", 10000),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (val_mod, ":original_modifier_no", 100000000),
       (val_mul, ":modifier_no", 100000000),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", ":original_modifier_no"),
    (try_end),
  ]),


#small tool
#replace the former operation troop_set_inventory_slot_modifier
#input troop no, slot no and modifier no. As there will be three modifier, when using this script, modifier will be automatically store in the smallest position. When there is no empty position, display a message.
#所用到的前缀都是item里新设置的，不能直接把inventory_get_item_slot_modifier得到的结果拿过来用。
  ("troop_set_new_inventory_slot_modifier", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":slot_no", 2),    #inventory slot no
    (store_script_param, ":modifier_no", 3),
    (store_add, ":inventory_modifier_slot_no", ":slot_no", 1201),#slot no begin from 0
    (troop_get_slot, ":original_modifier_no", ":troop_no", ":inventory_modifier_slot_no"),
    (try_begin),
       (lt, ":original_modifier_no", 0),
       (assign, ":original_modifier_no", 0),
    (try_end),
    (assign, ":computed_original_modifier_no", ":original_modifier_no"),
    (try_begin),
       (store_mod, ":return_value", ":computed_original_modifier_no", 10000),
       (le, ":return_value", 0),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (val_sub, ":computed_original_modifier_no", ":return_value"),
       (store_mod, ":return_value", ":computed_original_modifier_no", 100000000),
       (le, ":return_value", 0),
       (val_mul, ":modifier_no", 10000),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (val_sub, ":computed_original_modifier_no", ":return_value"),
       (store_div, ":return_value", ":computed_original_modifier_no", 100000000),
       (le, ":return_value", 0),
       (val_mul, ":modifier_no", 100000000),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (display_message, "str_cant_have_more_modifier"),
    (try_end),
    (try_begin),
       (ge, ":modifier_no", "itm_imod_0"),
       (le, ":modifier_no", "itm_imod_42"),       #43 original imod
       (val_sub, ":modifier_no", "itm_imod_0"),
       (try_begin),
          (eq, ":troop_no", "trp_player"),
          (call_script, "script_player_set_original_inventory_slot_modifier", ":slot_no", ":modifier_no"),
       (else_try),
          (troop_set_inventory_slot_modifier, ":troop_no", ":slot_no", ":modifier_no"),
       (try_end),
    (try_end),
  ]),


#small tool
#替代troop_get_inventory_slot_modifier获取前缀，不过只能用于原始的43前缀，也就是三个前缀中的第一个。
#input slot no
#output modifier no. When this slot have no item, output -1; When the input is out of the capacity, output -2.
  ("player_get_original_inventory_slot_modifier", 
  [
    (store_script_param, ":slot_no", 1),
    (assign, ":item_no", -2),

    (call_script, "script_player_get_new_inventory_capacity"),
    (assign, ":player_capacity", reg0),
    (try_begin),
       (lt, ":slot_no", ":player_capacity"),#slot no begin from 0
       (assign, ":item_no", -1),
    (try_end),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (eq, ":item_no", -1),
       (lt, ":slot_no", ":original_inventory"),
       (troop_get_inventory_slot_modifier, ":modifier_no", "trp_player", ":slot_no"),
    (else_try),
       (eq, ":item_no", -1),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_get_inventory_slot_modifier, ":modifier_no", "trp_player_additional_inventory_1", ":slot_no"),
    (else_try),
       (eq, ":item_no", -1),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_get_inventory_slot_modifier, ":modifier_no", "trp_player_additional_inventory_2", ":slot_no"),
    (try_end),

    (assign, reg0, ":modifier_no"),
  ]),


#small tool
#replace the former operation troop_set_inventory_slot_modifier, and use for those 43 original modifiers, only used by player. When the inventory slot is smaller then the ture capacity of player inventory, #this two are the same.
#input slot no and modifier no
  ("player_set_original_inventory_slot_modifier", 
  [
    (store_script_param, ":slot_no", 1),
    (store_script_param, ":modifier_no", 2),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (lt, ":slot_no", ":original_inventory"),
       (troop_set_inventory_slot_modifier, "trp_player", ":slot_no", ":modifier_no"),
    (else_try),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_set_inventory_slot_modifier, "trp_player_additional_inventory_1", ":slot_no", ":modifier_no"),
    (else_try),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_set_inventory_slot_modifier, "trp_player_additional_inventory_2", ":slot_no", ":modifier_no"),
    (try_end),
  ]),


#small tool
#remove certain item modifier when inventory slot is confirmed
#input troop no and slot no and modifier no
  ("troop_remove_new_inventory_slot_modifier", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":slot_no", 2),
    (store_add, ":inventory_modifier_slot_no", ":slot_no", 1201),#slot no begin from 0
    (troop_set_slot,  ":troop_no", ":inventory_modifier_slot_no", -1),
  ]),


#small tool
#常用，快捷添加物品
#replace the former operation troop_add_item, include modifier, used for NPCs, and will automatically fullfill the smallest slot, while when uesd for player, the #smallest slot was concluded from 24. Empty inventory slot should be ensured. 
#input troop no and item no and modifier no. If there is no modifier, input 0. 
  ("troop_add_item_with_modifier_new", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":item_no", 2),
    (assign, ":modifier_no_1", 0),
    (assign, ":modifier_no_2", 0),
    (assign, ":modifier_no_3", 0),
    (store_script_param, ":modifier_no_1", 3),
    (store_script_param, ":modifier_no_2", 4),
    (store_script_param, ":modifier_no_3", 5),

    (try_begin),
       (eq, ":troop_no", "trp_player"),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_mul, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 24, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, -1), #empty
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (call_script, "script_player_set_new_inventory_slot", ":count_no", ":item_no"),
       (str_store_item_name, s1, ":item_no"),
       (display_message, "@获 得 {s1}", 0x32CD32),
    (else_try),
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),
       (try_for_range, ":count_no", 10, ":inventory_capacity"),
          (troop_get_inventory_slot, ":if_have_item", ":troop_no", ":count_no"),
          (lt, ":if_have_item", 0), #empty
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (troop_set_inventory_slot, ":troop_no", ":count_no", ":item_no"),
    (try_end),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":troop_no", ":count_no", ":modifier_no_1"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":troop_no", ":count_no", ":modifier_no_2"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":troop_no", ":count_no", ":modifier_no_3"),
  ]),


#small tool
#常用，检测某troop是否有某物品（全物品栏）.
#且可以检测前缀。不需要前缀就输入-1。返回reg1记录最前一位的该物品在哪里，没有就返回-1
  ("troop_has_item_with_modifier_new", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":item_no", 2),
    (store_script_param, ":modifier_no", 3),

    (assign, ":continue_no", -1),
    (try_begin),
       (eq, ":troop_no", "trp_player"),#玩家，无前缀
       (eq, ":modifier_no", -1),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 0, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, ":item_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (eq, ":inventory_capacity", 0),#成功获取
       (assign, ":continue_no", ":count_no"),
    (else_try),
       (neq, ":troop_no", "trp_player"),#非玩家，无前缀
       (eq, ":modifier_no", -1),
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 0, ":inventory_capacity"),
          (troop_get_inventory_slot, ":item_get", ":troop_no", ":count_no"),
          (eq, ":item_get", ":item_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (eq, ":inventory_capacity", 0),#成功获取
       (assign, ":continue_no", ":count_no"),

    (else_try),
       (eq, ":troop_no", "trp_player"),#玩家，有前缀
       (ge, ":modifier_no", 0),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 0, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, ":item_no"),
          (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":count_no"),
          (this_or_next|eq, reg0, ":modifier_no"),
          (this_or_next|eq, reg1, ":modifier_no"),
          (eq, reg2, ":modifier_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (eq, ":inventory_capacity", 0),#成功获取
       (assign, ":continue_no", ":count_no"),
    (else_try),
       (neq, ":troop_no", "trp_player"),#玩家，有前缀
       (ge, ":modifier_no", 0),
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),#非玩家，有前缀
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 0, ":inventory_capacity"),
          (troop_get_inventory_slot, ":item_get", ":troop_no", ":count_no"),
          (eq, ":item_get", ":item_no"),
          (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":count_no"),
          (this_or_next|eq, reg0, ":modifier_no"),
          (this_or_next|eq, reg1, ":modifier_no"),
          (eq, reg2, ":modifier_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (eq, ":inventory_capacity", 0),#成功获取
       (assign, ":continue_no", ":count_no"),
    (try_end),

    (assign, reg1, ":continue_no"),
  ]),


#small tool
#常用，检测某troop是否有装备（玩家24位及以前，troop的10位以前）
#且可以检测前缀。不需要前缀就输入-1。
  ("cf_troop_has_item_equipped_with_modifier_new", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":item_no", 2),
    (store_script_param, ":modifier_no", 3),
    (call_script, "script_troop_has_item_with_modifier_new", ":troop_no", ":item_no", ":modifier_no"),
    (gt, reg1, -1),#持有该物品
    (assign, ":slot_no", reg1),

    (assign, ":continue_no", 0),
    (try_begin),
       (eq, ":troop_no", "trp_player"),#玩家
       (le, ":slot_no", 24),
       (assign, ":continue_no", 1),
    (else_try),
       (lt, ":slot_no", 10),
       (assign, ":continue_no", 1),
    (try_end),
    (gt, ":continue_no", 0),
  ]),


#small tool
#高级版的troop_add_item_with_modifier_new，不过只能给玩家用。会自动识别物品种类，装备进对应的位置
#input slot no and item no
  ("player_add_and_equip_item_with_modifier_new", 
  [
    (store_script_param, ":item_no", 1),
    (assign, ":modifier_no_1", 0),
    (assign, ":modifier_no_2", 0),
    (assign, ":modifier_no_3", 0),
    (store_script_param, ":modifier_no_1", 2),
    (store_script_param, ":modifier_no_2", 3),
    (store_script_param, ":modifier_no_3", 4),

    (item_get_type, ":type_no", ":item_no"),
    (try_begin),
       (eq, ":type_no", itp_type_head_armor),                                                                #头
       (troop_set_inventory_slot, "trp_player", ek_head, ":item_no"),
       (assign, ":count_no", ek_head),
    (else_try),
       (eq, ":type_no", itp_type_body_armor),                                                                #甲
       (troop_set_inventory_slot, "trp_player", ek_body, ":item_no"),
       (assign, ":count_no", ek_body),
    (else_try),
       (eq, ":type_no", itp_type_foot_armor),                                                                  #脚
       (troop_set_inventory_slot, "trp_player", ek_foot, ":item_no"),
       (assign, ":count_no", ek_foot),
    (else_try),
       (eq, ":type_no", itp_type_hand_armor),                                                                #手
       (troop_set_inventory_slot, "trp_player", ek_gloves, ":item_no"),
       (assign, ":count_no", ek_gloves),
    (else_try),
       (eq, ":type_no", itp_type_horse),                                                                           #马
       (troop_set_inventory_slot, "trp_player", ek_horse, ":item_no"),
       (assign, ":count_no", ek_horse),
    (else_try),
       (eq, ":type_no", itp_type_goods),                                                                        #补给
       (item_has_property, ":item_no", itp_supply),
       (troop_set_inventory_slot, "trp_player", ek_food, ":item_no"),
       (assign, ":count_no", ek_food),
    (else_try),
       (this_or_next|eq, ":type_no", itp_type_one_handed_wpn),                                 #右手
       (this_or_next|eq, ":type_no", itp_type_two_handed_wpn),
       (this_or_next|eq, ":type_no", itp_type_polearm),
       (this_or_next|eq, ":type_no", itp_type_crossbow),
       (this_or_next|eq, ":type_no", itp_type_thrown),
       (this_or_next|eq, ":type_no", itp_type_pistol),
       (eq, ":type_no", itp_type_musket),
       (assign, ":limit_no", ek_left_hand_1),
       (try_for_range, ":count_no", ek_right_hand_1, ":limit_no"),
          (troop_get_inventory_slot, ":if_have_item", "trp_player", ":count_no"),
          (lt, ":if_have_item", 0), #empty
          (assign, ":limit_no", 0),#break
       (try_end),
       (troop_set_inventory_slot, "trp_player", ":count_no", ":item_no"),
    (else_try),
       (this_or_next|eq, ":type_no", itp_type_shield),                                                     #左手
       (eq, ":type_no", itp_type_bow),
       (assign, ":limit_no", ek_accessorise_1),
       (try_for_range, ":count_no", ek_left_hand_1, ":limit_no"),
          (troop_get_inventory_slot, ":if_have_item", "trp_player", ":count_no"),
          (lt, ":if_have_item", 0), #empty
          (assign, ":limit_no", 0),#break
       (try_end),
       (troop_set_inventory_slot, "trp_player", ":count_no", ":item_no"),
    (else_try),
       (this_or_next|eq, ":type_no", itp_type_arrows),                                                   #远程弹药
       (this_or_next|eq, ":type_no", itp_type_bullets),
       (eq, ":type_no", itp_type_bolts),
       (assign, ":limit_no", ek_head),
       (try_for_range, ":count_no", ek_item_2, ":limit_no"),
          (troop_get_inventory_slot, ":if_have_item", "trp_player", ":count_no"),
          (lt, ":if_have_item", 0), #empty
          (assign, ":limit_no", 0),#break
       (try_end),
       (troop_set_inventory_slot, "trp_player", ":count_no", ":item_no"),
    (else_try),
       (eq, ":type_no", itp_type_goods),                                                                         #首饰
       (item_has_property, ":item_no", itp_accessorise),
       (assign, ":limit_no", ek_small_tool_1),
       (try_for_range, ":count_no", ek_accessorise_1, ":limit_no"),
          (troop_get_inventory_slot, ":if_have_item", "trp_player", ":count_no"),
          (lt, ":if_have_item", 0), #empty
          (assign, ":limit_no", 0),#break
       (try_end),
       (troop_set_inventory_slot, "trp_player", ":count_no", ":item_no"),
    (else_try),
       (eq, ":type_no", itp_type_goods),                                                                         #小道具
       (item_has_property, ":item_no", itp_small_tool),
       (assign, ":limit_no", 24),
       (try_for_range, ":count_no", ek_small_tool_1, ":limit_no"),
          (troop_get_inventory_slot, ":if_have_item", "trp_player", ":count_no"),
          (lt, ":if_have_item", 0), #empty
          (assign, ":limit_no", 0),#break
       (try_end),
       (troop_set_inventory_slot, "trp_player", ":count_no", ":item_no"),
    (else_try),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_mul, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 24, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, -1), #empty
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (call_script, "script_player_set_new_inventory_slot", ":count_no", ":item_no"),
    (try_end),
    (call_script, "script_troop_set_new_inventory_slot_modifier", "trp_player", ":count_no", ":modifier_no_1"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", "trp_player", ":count_no", ":modifier_no_2"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", "trp_player", ":count_no", ":modifier_no_3"),
  ]),


#常用，根据前缀清除物品
#small tool
#替换原有操作符troop_remove_item且可讲前缀考虑在内。使用时可用前缀指定物品，或者输入-1以消除前缀的影响。有多个同类物品时，被移除的是第一个。
#input troop no and item no and modifier no. 
  ("troop_remove_item_with_modifier_new", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":item_no", 2),
    (store_script_param, ":modifier_no", 3),

    (try_begin),
       (eq, ":troop_no", "trp_player"),
       (eq, ":modifier_no", -1),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 24, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, ":item_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (call_script, "script_player_remove_new_inventory_slot", ":count_no"),
       (str_store_item_name, s1, ":item_no"),
       (display_message, "@失 去 {s1}"),
    (else_try),
       (eq, ":modifier_no", -1),
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 10, ":inventory_capacity"),
          (troop_get_inventory_slot, ":item_get", ":troop_no", ":count_no"),
          (eq, ":item_get", ":item_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (troop_set_inventory_slot, ":troop_no", ":count_no", -1),
    (else_try),
       (eq, ":troop_no", "trp_player"),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 24, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, ":item_no"),
          (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":count_no"),
          (this_or_next|eq, reg0, ":modifier_no"),
          (this_or_next|eq, reg1, ":modifier_no"),
          (eq, reg2, ":modifier_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (call_script, "script_player_remove_new_inventory_slot", ":count_no"),
       (str_store_item_name, s1, ":item_no"),
       (display_message, "@失 去 {s1}"),
    (else_try),
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 10, ":inventory_capacity"),
          (troop_get_inventory_slot, ":item_get", ":troop_no", ":count_no"),
          (eq, ":item_get", ":item_no"),
          (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":count_no"),
          (this_or_next|eq, reg0, ":modifier_no"),
          (this_or_next|eq, reg1, ":modifier_no"),
          (eq, reg2, ":modifier_no"),
          (assign, ":inventory_capacity", 0),#break
       (try_end),
       (troop_set_inventory_slot, ":troop_no", ":count_no", -1),
    (try_end),
    (call_script, "script_troop_remove_new_inventory_slot_modifier", ":troop_no", ":count_no"),
  ]),



#small tool
#统计某种item在指定troop的物品栏里有多少，也可以带上modifier。返回数量
#输入troop，item，也可以输入modifier，不需要就输入-1。
#输出reg1
  ("troop_caculate_item_num_with_modifier", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":item_no", 2),
    (store_script_param, ":modifier_no", 3),

    (assign, ":caculate_no", 0),
    (try_begin),
       (eq, ":modifier_no", -1),#玩家无前缀
       (eq, ":troop_no", "trp_player"),
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 24, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, ":item_no"),
          (val_add, ":caculate_no", 1),
       (try_end),
    (else_try),
       (eq, ":modifier_no", -1),#非玩家无前缀
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 10, ":inventory_capacity"),
          (troop_get_inventory_slot, ":item_get", ":troop_no", ":count_no"),
          (eq, ":item_get", ":item_no"),
          (val_add, ":caculate_no", 1),
       (try_end),
    (else_try),
       (eq, ":troop_no", "trp_player"),#玩家有前缀
       (call_script, "script_player_get_new_inventory_capacity"),
       (assign, ":inventory_capacity", reg0),
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 24, ":inventory_capacity"),
          (call_script, "script_player_get_new_inventory_slot", ":count_no"),
          (eq, reg0, ":item_no"),
          (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":count_no"),
          (this_or_next|eq, reg0, ":modifier_no"),
          (this_or_next|eq, reg1, ":modifier_no"),
          (eq, reg2, ":modifier_no"),
          (val_add, ":caculate_no", 1),
       (try_end),
    (else_try),
       (troop_get_inventory_capacity, ":inventory_capacity", ":troop_no"),#非玩家有前缀
       (val_add, ":inventory_capacity", 1),
       (try_for_range, ":count_no", 10, ":inventory_capacity"),
          (troop_get_inventory_slot, ":item_get", ":troop_no", ":count_no"),
          (eq, ":item_get", ":item_no"),
          (call_script, "script_troop_get_new_inventory_slot_modifier", ":troop_no", ":count_no"),
          (this_or_next|eq, reg0, ":modifier_no"),
          (this_or_next|eq, reg1, ":modifier_no"),
          (eq, reg2, ":modifier_no"),
          (val_add, ":caculate_no", 1),
       (try_end),
    (try_end),
    (assign, reg1, ":caculate_no"),
  ]),



#small tool
#input troop no and slot no
#output modifier no. There will be at most three modifiers, and take up reg0, reg1, reg2 respectively. When there is no four modifier, some reg will be zero.
  ("agent_get_new_inventory_slot_modifier", 
  [
    (store_script_param, ":agent_no", 1),
    (store_script_param, ":weapon_slot_no", 2),      #input $cur_weapon_right_hand and $cur_weapon_left_hand
    (assign, reg0, 0),
    (assign, reg1, 0),
    (assign, reg2, 0),
    (store_add, ":agent_modifier_slot_no", ":weapon_slot_no", 12),#slot no begin from 0
    (agent_get_slot, ":modifier_no", ":agent_no", ":agent_modifier_slot_no"),
    (store_mod, reg0, ":modifier_no", 10000),
    (val_sub, ":modifier_no", reg0),
    (store_mod, reg1, ":modifier_no", 100000000),
    (val_sub, ":modifier_no", reg0),
    (store_div, reg2, ":modifier_no", 100000000),
  ]),


#small tool
#input agent no, slot no and modifier no. As there will be three modifier, when using this script, modifier will be automatically store in the smallest position. When there is no empty position, display a message.
  ("agent_set_new_inventory_slot_modifier", 
  [
    (store_script_param, ":agent_no", 1),
    (store_script_param, ":weapon_slot_no", 2),    #input $cur_weapon_right_hand and $cur_weapon_left_hand
    (store_script_param, ":modifier_no", 3),
    (store_add, ":agent_modifier_slot_no", ":weapon_slot_no", 12),#slot no begin from 0
    (agent_get_slot, ":original_modifier_no", ":agent_no", ":agent_modifier_slot_no"),
    (try_begin),
       (lt, ":original_modifier_no", 0),
       (assign, ":original_modifier_no", 0),
    (try_end),
    (assign, ":computed_original_modifier_no", ":original_modifier_no"),
    (try_begin),
       (store_mod, ":return_value", ":computed_original_modifier_no", 10000),
       (le, ":return_value", 0),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (agent_set_slot,  ":agent_no", ":agent_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (val_sub, ":computed_original_modifier_no", ":return_value"),
       (store_mod, ":return_value", ":computed_original_modifier_no", 100000000),
       (le, ":return_value", 0),
       (val_mul, ":modifier_no", 10000),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (agent_set_slot,  ":agent_no", ":agent_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (val_sub, ":computed_original_modifier_no", ":return_value"),
       (store_div, ":return_value", ":computed_original_modifier_no", 100000000),
       (le, ":return_value", 0),
       (val_mul, ":modifier_no", 100000000),
       (val_add, ":original_modifier_no", ":modifier_no"),
       (agent_set_slot,  ":agent_no", ":agent_modifier_slot_no", ":original_modifier_no"),
    (else_try),
       (display_message, "str_cant_have_more_modifier"),
    (try_end),
  ]),



#small tool
#r替换原有操作符troop_inventory_slot_get_item_amount，只有玩家需要用
#输入物品栏slot
#输出物品量，比如食物的量。如果输入的slot超出物品栏容量，返回-1
  ("player_get_new_inventory_slot_amount", 
  [
    (store_script_param, ":slot_no", 1),
    (assign, ":item_amount", -1),

    (call_script, "script_player_get_new_inventory_capacity"),
    (assign, ":player_capacity", reg0),
    (try_begin),
       (lt, ":slot_no", ":player_capacity"),#slot no begin from 0
       (assign, ":item_no", 0),
    (try_end),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (eq, ":item_no", 0),
       (lt, ":slot_no", ":original_inventory"),
       (troop_inventory_slot_get_item_amount, ":item_amount", "trp_player", ":slot_no"),
    (else_try),
       (eq, ":item_no", 0),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_inventory_slot_get_item_amount, ":item_amount", "trp_player_additional_inventory_1", ":slot_no"),
    (else_try),
       (eq, ":item_no", 0),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_inventory_slot_get_item_amount, ":item_amount", "trp_player_additional_inventory_2", ":slot_no"),
    (try_end),

    (assign, reg0, ":item_amount"),
  ]),


#small tool
#替换原有操作符troop_inventory_slot_set_item_amount，只有玩家需要用，当输入的物品栏slot不超过玩家背包容量时，这两个其实是一样的。
#输入物品栏slot和物品量
  ("player_set_new_inventory_slot_amount", 
  [
    (store_script_param, ":slot_no", 1),
    (store_script_param, ":item_amount", 2),

    (troop_get_inventory_capacity, ":original_inventory", "trp_player"),
    (troop_get_inventory_capacity, ":additional_inventory_1", "trp_player_additional_inventory_1"),
    (troop_get_inventory_capacity, ":additional_inventory_2", "trp_player_additional_inventory_2"),
    (try_begin),
       (lt, ":slot_no", ":original_inventory"),
       (troop_inventory_slot_set_item_amount, "trp_player", ":slot_no", ":item_amount"),
    (else_try),
       (val_sub, ":slot_no", ":original_inventory"),
       (lt, ":slot_no", ":additional_inventory_1"),
       (troop_inventory_slot_set_item_amount, "trp_player_additional_inventory_1", ":slot_no", ":item_amount"),
    (else_try),
       (val_sub, ":slot_no", ":additional_inventory_1"),
       (lt, ":slot_no", ":additional_inventory_2"),
       (troop_inventory_slot_set_item_amount, "trp_player_additional_inventory_2", ":slot_no", ":item_amount"),
    (try_end),
  ]),


#small tool
#Used in presentation, reorder inventory overlay with the number of item type. When need to show all items, input -1.
#input weapon slot 23 is ammo. 4567 is head, body, shoes and gloves respectively. 8 and 9 is horse and supply, and 10,11,12 is right hand weapons, while 13,14,15 is of left hand, including shields and bows. 16 to 19 is accesseries, and 20 to 23 is small tool.
  ("new_inventory_reorder", 
  [
    (store_script_param, ":weapon_slot_no", 1), 
    (set_fixed_point_multiplier, 1000), #以防分辨率被不知道什么东西篡改
    (assign, "$item_reorder_indication", ":weapon_slot_no"),

    (call_script, "script_player_get_new_inventory_capacity"),
    (assign, ":player_capacity", reg0),

    (try_for_range, ":slot_no", 24, ":player_capacity"),
       (troop_get_slot, ":overlay_no", "trp_temp_array_a", ":slot_no"),
       (overlay_set_display, ":overlay_no", 0),
       (val_add, ":overlay_no", 1),
       (overlay_set_display, ":overlay_no", 0),

       (troop_get_slot, ":overlay_no", "trp_temp_array_b", ":slot_no"),
       (overlay_set_display, ":overlay_no", 0),
    (try_end),


    (assign, ":cur_x", 5),
    (assign, ":cur_y", 1800),
    (try_for_range, ":slot_no", 24, ":player_capacity"),
       (assign, ":continue_no", 0),
       (try_begin),
          (eq, ":weapon_slot_no", -1),
          (assign, ":continue_no", 1),
       (else_try),
          (call_script, "script_player_get_new_inventory_slot", ":slot_no"),
          (assign, ":item_no", reg0),
          (lt, ":item_no", 0),
          (assign, ":continue_no", 1),
       (else_try),
          (call_script, "script_check_if_two_inventory_slot_are_same_kind", ":slot_no", ":weapon_slot_no"),
          (assign, ":continue_no", reg0),
       (try_end),
       (eq, ":continue_no", 1),

       (troop_get_slot, ":overlay_no", "trp_temp_array_a", ":slot_no"),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),#normal inventory
       (val_add, ":overlay_no", 1),
       (overlay_set_display, ":overlay_no", 1),
       (overlay_set_position, ":overlay_no", pos1),#highlight inventory

       (troop_get_slot, ":overlay_no", "trp_temp_array_b", ":slot_no"),
       (overlay_set_display, ":overlay_no", 1),
       (store_add, ":cur_x_2", ":cur_x", 35),
       (store_add, ":cur_y_2", ":cur_y", 35),
       (position_set_x, pos1, ":cur_x_2"),
       (position_set_y, pos1, ":cur_y_2"),
       (overlay_set_position, ":overlay_no", pos1),#item mesh

       (try_begin),
          (neq, ":cur_x", 155),
          (val_add, ":cur_x", 75),
       (else_try),
          (assign, ":cur_x", 5),
          (val_sub, ":cur_y", 75),
       (try_end),
    (try_end),
  ]),


#small tool
#A small tool used for get whether two equipped weapon can change or not
#input two weapon slot, output 0 when disable, and 1 for able.
  ("check_if_two_inventory_slot_are_same_kind", 
  [
    (store_script_param, ":slot_no_1", 1),
    (store_script_param, ":slot_no_2", 2),
    (assign, ":can_change_or_not", 0),

    (try_begin),
       (eq, ":slot_no_1", ":slot_no_2"),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (this_or_next|le, ":slot_no_1", 0),
       (le, ":slot_no_2", 0),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (ge, ":slot_no_1", 24),
       (ge, ":slot_no_2", 24),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (is_between, ":slot_no_1", 10, 13),
       (is_between, ":slot_no_2", 10, 13),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (is_between, ":slot_no_1", 13, 16),
       (is_between, ":slot_no_2", 13, 16),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (is_between, ":slot_no_1", 16, 20),
       (is_between, ":slot_no_2", 16, 20),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (is_between, ":slot_no_1", 20, 24),
       (is_between, ":slot_no_2", 20, 24),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (is_between, ":slot_no_1", 2, 4),
       (is_between, ":slot_no_2", 2, 4),
       (assign, ":can_change_or_not", 1),
    (else_try),
       (ge, ":slot_no_2", 24),
       (is_between, ":slot_no_1", 0, 24),
       (call_script, "script_player_get_new_inventory_slot", ":slot_no_2"),
       (assign, ":item_no", reg0), 
       (ge, ":item_no", 0),
       (item_get_type, ":type_no", ":item_no"),
       (try_begin),
          (is_between, ":slot_no_1", 10, 13),#right hand, including one hand, two hand, polearm, crossbow, thrown, pistol and musket
          (this_or_next|eq, ":type_no", itp_type_one_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_two_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_polearm),
          (this_or_next|eq, ":type_no", itp_type_crossbow),
          (this_or_next|eq, ":type_no", itp_type_thrown),
          (this_or_next|eq, ":type_no", itp_type_pistol),
          (eq, ":type_no", itp_type_musket),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (is_between, ":slot_no_1", 13, 16),#left hand, including shield and bow
          (this_or_next|eq, ":type_no", itp_type_shield),
          (eq, ":type_no", itp_type_bow),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_1", 4),#head
          (eq, ":type_no", itp_type_head_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_1", 5),#body
          (eq, ":type_no", itp_type_body_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_1", 6),#foot
          (eq, ":type_no", itp_type_foot_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_1", 7),#glove
          (eq, ":type_no", itp_type_hand_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (this_or_next|eq, ":slot_no_1", 2),#ammo
          (eq, ":slot_no_1", 3),#ammo
          (this_or_next|eq, ":type_no", itp_type_arrows),
          (this_or_next|eq, ":type_no", itp_type_bullets),
          (eq, ":type_no", itp_type_bolts),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_1", 8),#horse
          (eq, ":type_no", itp_type_horse),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_1", 9),#急救包supply
          (eq, ":type_no", itp_type_goods),
          (item_has_property, ":item_no", itp_supply),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (is_between, ":slot_no_1", 16, 20),#首饰accessorise
          (eq, ":type_no", itp_type_goods),
          (item_has_property, ":item_no", itp_accessorise),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (is_between, ":slot_no_1", 20, 24),#道具small tool
          (eq, ":type_no", itp_type_goods),
          (item_has_property, ":item_no", itp_small_tool),
          (assign, ":can_change_or_not", 1),
       (try_end),
    (else_try),
       (ge, ":slot_no_1", 24),
       (is_between, ":slot_no_2", 0, 24),
       (call_script, "script_player_get_new_inventory_slot", ":slot_no_1"),
       (assign, ":item_no", reg0), 
       (ge, ":item_no", 0),
       (item_get_type, ":type_no", ":item_no"),
       (try_begin),
          (is_between, ":slot_no_2", 10, 13),#right hand, including one hand, two hand, polearm, crossbow, thrown, pistol and musket
          (this_or_next|eq, ":type_no", itp_type_one_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_two_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_polearm),
          (this_or_next|eq, ":type_no", itp_type_crossbow),
          (this_or_next|eq, ":type_no", itp_type_thrown),
          (this_or_next|eq, ":type_no", itp_type_pistol),
          (eq, ":type_no", itp_type_musket),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (is_between, ":slot_no_2", 13, 16),#left hand, including shield and bow
          (this_or_next|eq, ":type_no", itp_type_shield),
          (eq, ":type_no", itp_type_bow),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_2", 4),#head
          (eq, ":type_no", itp_type_head_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_2", 5),#body
          (eq, ":type_no", itp_type_body_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_2", 6),#foot
          (eq, ":type_no", itp_type_foot_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_2", 7),#glove
          (eq, ":type_no", itp_type_hand_armor),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (this_or_next|eq, ":slot_no_2", 2),#ammo
          (eq, ":slot_no_2", 3),#ammo
          (this_or_next|eq, ":type_no", itp_type_arrows),
          (this_or_next|eq, ":type_no", itp_type_bullets),
          (eq, ":type_no", itp_type_bolts),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_2", 8),#horse
          (eq, ":type_no", itp_type_horse),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (eq, ":slot_no_2", 9),#急救包supply
          (eq, ":type_no", itp_type_goods),
          (item_has_property, ":item_no", itp_supply),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (is_between, ":slot_no_2", 16, 20),#首饰accessorise
          (eq, ":type_no", itp_type_goods),
          (item_has_property, ":item_no", itp_accessorise),
          (assign, ":can_change_or_not", 1),
       (else_try),
          (is_between, ":slot_no_2", 20, 24),#道具small tool
          (eq, ":type_no", itp_type_goods),
          (item_has_property, ":item_no", itp_small_tool),
          (assign, ":can_change_or_not", 1),
       (try_end),
    (try_end),

    (assign, reg0, ":can_change_or_not"),
  ]),


#small tool
#Exchange two item mesh and inventory slot when count no is insure.
  ("exchange_two_item", 
  [
    (store_script_param, ":exchange_1", 1),
    (store_script_param, ":exchange_troop_1", 2),
    (store_script_param, ":exchange_2", 3),
    (store_script_param, ":exchange_troop_2", 4),

    (troop_get_slot, ":item_overlay_1", "trp_temp_array_b", ":exchange_1"),
    (troop_get_slot, ":item_overlay_2", "trp_temp_array_b", ":exchange_2"),
    (overlay_get_position, pos1, ":item_overlay_1"),
    (overlay_get_position, pos2, ":item_overlay_2"),

    (troop_set_slot, "trp_temp_array_b", ":exchange_1", ":item_overlay_2"),
    (troop_set_slot, "trp_temp_array_b", ":exchange_2", ":item_overlay_1"),

    (try_begin),
       (ge, ":exchange_1", 24),
       (ge, ":exchange_2", 24),
       (call_script, "script_new_inventory_reorder", "$item_reorder_indication"),
    (else_try),
       (lt, ":exchange_1", 24),
       (lt, ":exchange_2", 24),
       (overlay_set_position, ":item_overlay_1", pos2),
       (overlay_set_position, ":item_overlay_2", pos1),
    (else_try),
       (ge, ":exchange_1", 24),
       (overlay_set_container_overlay, ":item_overlay_1", -1),
       (overlay_set_position, ":item_overlay_1", pos2),
       (overlay_set_container_overlay, ":item_overlay_2", "$g_presentation_container_1"),
       (call_script, "script_new_inventory_reorder", ":exchange_2"),
    (else_try),
       (ge, ":exchange_2", 24),
       (overlay_set_container_overlay, ":item_overlay_2", -1),
       (overlay_set_position, ":item_overlay_2", pos1),
       (overlay_set_container_overlay, ":item_overlay_1", "$g_presentation_container_1"),
       (call_script, "script_new_inventory_reorder", ":exchange_1"),
    (try_end),

    (call_script, "script_troop_get_new_inventory_slot_modifier", ":exchange_troop_1", ":exchange_1"),
    (assign, ":modifier_1_1", reg0),
    (assign, ":modifier_1_2", reg1),
    (assign, ":modifier_1_3", reg2),
    (call_script, "script_troop_get_new_inventory_slot_modifier", ":exchange_troop_2", ":exchange_2"),
    (assign, ":modifier_2_1", reg0),
    (assign, ":modifier_2_2", reg1),
    (assign, ":modifier_2_3", reg2),

    (call_script, "script_player_get_new_inventory_slot_amount", ":exchange_1"),
    (assign, ":item_amount_1", reg0),
    (call_script, "script_player_get_new_inventory_slot_amount", ":exchange_2"),
    (assign, ":item_amount_2", reg0),
    (call_script, "script_player_get_new_inventory_slot", ":exchange_1"),
    (assign, ":item_1", reg0),
    (call_script, "script_player_get_new_inventory_slot", ":exchange_2"),
    (assign, ":item_2", reg0),

    (call_script, "script_player_set_new_inventory_slot", ":exchange_1", ":item_2"),
    (call_script, "script_player_set_new_inventory_slot", ":exchange_2", ":item_1"),

    (try_begin),
       (gt, ":item_1", 0),
       (item_get_type, ":item_type_1", ":item_1"),
    (try_end),
    (try_begin),
       (gt, ":item_2", 0),
       (item_get_type, ":item_type_2", ":item_2"),
    (try_end),

    (try_begin),
       (gt, ":item_amount_2", 0),
       (eq, ":item_type_2", itp_type_goods),
       (call_script, "script_player_set_new_inventory_slot_amount", ":exchange_1", ":item_amount_2"),
    (try_end),
    (try_begin),
       (gt, ":item_amount_2", 0),
       (eq, ":item_type_1", itp_type_goods),
       (call_script, "script_player_set_new_inventory_slot_amount", ":exchange_2", ":item_amount_1"),
    (try_end),

    (call_script, "script_troop_remove_new_inventory_slot_modifier", ":exchange_troop_1", ":exchange_1"),
    (call_script, "script_troop_remove_new_inventory_slot_modifier", ":exchange_troop_2", ":exchange_2"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":exchange_troop_1", ":exchange_1", ":modifier_2_1"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":exchange_troop_1", ":exchange_1", ":modifier_2_2"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":exchange_troop_1", ":exchange_1", ":modifier_2_3"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":exchange_troop_2", ":exchange_2", ":modifier_1_1"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":exchange_troop_2", ":exchange_2", ":modifier_1_2"),
    (call_script, "script_troop_set_new_inventory_slot_modifier", ":exchange_troop_2", ":exchange_2", ":modifier_1_3"),

    (troop_get_slot,  ":overlay_background", "trp_temp_array_a", ":exchange_1"),
    (call_script, "script_lowlight_certain_block", ":overlay_background"),
    (troop_get_slot,  ":overlay_background", "trp_temp_array_a", ":exchange_2"),
    (call_script, "script_lowlight_certain_block", ":overlay_background"),
  ]),


#small tool
#input overlay number
  ("highlight_certain_block", 
  [
    (store_script_param_1, ":overlay_background"),
    (overlay_set_additional_render_height, ":overlay_background", 1),
    (val_add, ":overlay_background", 1),
    (overlay_set_additional_render_height, ":overlay_background", 2),
  ]),


#small tool
#input overlay number
  ("lowlight_certain_block", 
  [
    (store_script_param_1, ":overlay_background"),
    (overlay_set_additional_render_height, ":overlay_background", 2),
    (val_add, ":overlay_background", 1),
    (overlay_set_additional_render_height, ":overlay_background", 1),
  ]),


#small tool
#replaced to create the item details show in the middle of inventory window 
#input item no(can fail)
  ("cf_inventory_show_item_create", 
  [
    (store_script_param_1, ":item_no"),
    (ge, ":item_no", 0),

    (create_mesh_overlay_with_item_id, "$g_presentation_obj_3", ":item_no"),
    (set_fixed_point_multiplier, 1000),                #以防盾牌或铠甲改变分辨率
    (position_set_x, pos1, 650),
    (position_set_y, pos1, 495),
    (overlay_set_position, "$g_presentation_obj_3", pos1),
    (position_set_x, pos1, 2000),
    (position_set_y, pos1, 2000),
    (overlay_set_size, "$g_presentation_obj_3", pos1),

    (create_text_overlay, "$g_presentation_text_1", "@ "),#item name
    (position_set_x, pos1, 350),
    (position_set_y, pos1, 610),
    (overlay_set_position, "$g_presentation_text_1", pos1),
    (position_set_x, pos1, 1200),
    (position_set_y, pos1, 1200),
    (overlay_set_size, "$g_presentation_text_1", pos1),
    (overlay_set_color, "$g_presentation_text_1", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_2", "@ "),#item type
    (position_set_x, pos1, 350),
    (position_set_y, pos1, 585),
    (overlay_set_position, "$g_presentation_text_2", pos1),
    (position_set_x, pos1, 750),
    (position_set_y, pos1, 750),
    (overlay_set_size, "$g_presentation_text_2", pos1),
    (overlay_set_color, "$g_presentation_text_2", 0xCCCCFF),

    (create_text_overlay, "$g_presentation_text_3", "@ "),#item price
    (position_set_x, pos1, 550),
    (position_set_y, pos1, 585),
    (overlay_set_position, "$g_presentation_text_3", pos1),
    (position_set_x, pos1, 750),
    (position_set_y, pos1, 750),
    (overlay_set_size, "$g_presentation_text_3", pos1),
    (overlay_set_color, "$g_presentation_text_3", 0xFFFF66),

    (create_text_overlay, reg1, "@ ", tf_scrollable),
    (position_set_x, pos1, 350),
    (position_set_y, pos1, 100),
    (overlay_set_position, reg1, pos1),
    (position_set_x, pos1, 160),
    (position_set_y, pos1, 170),
    (overlay_set_area_size, reg1, pos1),
    (set_container_overlay, reg1),

    (create_text_overlay, "$g_presentation_text_4", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_4", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_4", pos1),
    (overlay_set_color, "$g_presentation_text_4", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_5", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_5", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_5", pos1),
    (overlay_set_color, "$g_presentation_text_5", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_6", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_6", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_6", pos1),
    (overlay_set_color, "$g_presentation_text_6", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_7", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_7", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_7", pos1),
    (overlay_set_color, "$g_presentation_text_7", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_8", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_8", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_8", pos1),
    (overlay_set_color, "$g_presentation_text_8", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_9", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_9", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_9", pos1),
    (overlay_set_color, "$g_presentation_text_9", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_10", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_10", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_10", pos1),
    (overlay_set_color, "$g_presentation_text_10", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_11", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_11", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_11", pos1),
    (overlay_set_color, "$g_presentation_text_11", 0x66FFFF),

    (create_text_overlay, "$g_presentation_text_12", "@ "),#accuracy
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_12", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_12", pos1),
    (overlay_set_color, "$g_presentation_text_12", 0xCC99FF),

    (create_text_overlay, "$g_presentation_text_13", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_13", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_13", pos1),
    (overlay_set_color, "$g_presentation_text_13", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_14", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_14", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_14", pos1),
    (overlay_set_color, "$g_presentation_text_14", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_15", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_15", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_15", pos1),
    (overlay_set_color, "$g_presentation_text_15", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_16", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_16", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_16", pos1),
    (overlay_set_color, "$g_presentation_text_16", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_17", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_17", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_17", pos1),
    (overlay_set_color, "$g_presentation_text_17", 0xFFCCCC),

    (create_text_overlay, "$g_presentation_text_18", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_18", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_18", pos1),
    (overlay_set_color, "$g_presentation_text_18", 0xFFCCCC),

    (create_text_overlay, "$g_presentation_text_19", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_19", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_19", pos1),
    (overlay_set_color, "$g_presentation_text_19", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_20", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_20", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_20", pos1),
    (overlay_set_color, "$g_presentation_text_20", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_21", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_21", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_21", pos1),
    (overlay_set_color, "$g_presentation_text_21", 0xFFFFFF),

    (create_text_overlay, "$g_presentation_text_22", "@ "),
    (position_set_x, pos1, 0),
    (position_set_y, pos1, 0),
    (overlay_set_position, "$g_presentation_text_22", pos1),
    (position_set_x, pos1, 800),
    (position_set_y, pos1, 800),
    (overlay_set_size, "$g_presentation_text_22", pos1),
    (overlay_set_color, "$g_presentation_text_22", 0xFFFFFF),

    (set_container_overlay, -1),

    (create_text_overlay, "$g_presentation_container_2", "@ ", tf_scrollable),
    (position_set_x, pos1, 600),
    (position_set_y, pos1, 400),
    (overlay_set_position, "$g_presentation_container_2", pos1),
    (position_set_x, pos1, 70),
    (position_set_y, pos1, 150),
    (overlay_set_area_size, "$g_presentation_container_2", pos1),
    (set_container_overlay, "$g_presentation_container_2"),

    (try_for_range, ":count_no", 0, 12),#buff and debuff
       (store_add, ":mesh_no", ":count_no", "mesh_item_property_couchable"),
       (create_mesh_overlay, reg1, ":mesh_no"),
       (position_set_x, pos1, 0),
       (position_set_y, pos1, 0),
       (overlay_set_position, reg1, pos1),
       (position_set_x, pos1, 32),
       (position_set_y, pos1, 35),
       (overlay_set_size, reg1, pos1),
       (troop_set_slot, "trp_temp_array_c", ":count_no", reg1),
       (overlay_set_display, reg1, 0),
    (try_end),

    (set_container_overlay, -1),

    (create_text_overlay, "$g_presentation_text_23", "@ ", tf_scrollable),
    (position_set_x, pos1, 350),
    (position_set_y, pos1, 290),
    (overlay_set_position, "$g_presentation_text_23", pos1),
    (position_set_x, pos1, 750),
    (position_set_y, pos1, 750),
    (overlay_set_size, "$g_presentation_text_23", pos1),
    (overlay_set_color, "$g_presentation_text_23", 0xFFFFFF),
    (position_set_x, pos1, 350),
    (position_set_y, pos1, 110),
    (overlay_set_area_size, "$g_presentation_text_23", pos1),
#    (set_container_overlay, "$g_presentation_text_23"),
#    (set_container_overlay, -1),
  ]),


#replaced to update the item details show in the middle of inventory window 
#input item no(can fail) and inventory slot no, which is optional. If dont need count food consumption(like change item for npc), input -1.
  ("cf_inventory_show_item_change", 
  [
    (store_script_param_1, ":item_no"),
    (store_script_param_2, ":inventory_slot_no"),
    (gt, ":item_no", 0),
    (assign, "$item_display_indication", ":item_no"),

    (overlay_set_display, "$g_presentation_obj_3", 0),
    (create_mesh_overlay_with_item_id, "$g_presentation_obj_3", ":item_no"),
    (set_fixed_point_multiplier, 1000),                #以防盾牌或铠甲改变分辨率
    (position_set_x, pos1, 500),
    (position_set_y, pos1, 500),
    (overlay_set_position, "$g_presentation_obj_3", pos1),
    (position_set_x, pos1, 2000),
    (position_set_y, pos1, 2000),
    (overlay_set_size, "$g_presentation_obj_3", pos1),

    (call_script, "script_troop_get_new_inventory_slot_modifier", "trp_player", ":inventory_slot_no"),#get modifier
    (assign, ":original_modifier_no", 0),
    (try_begin),
       (gt, reg0, "itm_imod_0"),
       (le, reg0, "itm_imod_42"),
       (store_sub, ":original_modifier_no", reg0, "itm_imod_0"),
    (else_try),
       (gt, reg1, "itm_imod_0"),
       (le, reg1, "itm_imod_42"),
       (store_sub, ":original_modifier_no", reg1, "itm_imod_0"),
    (else_try),
       (gt, reg2, "itm_imod_0"),
       (le, reg2, "itm_imod_42"),
       (store_sub, ":original_modifier_no", reg2, "itm_imod_0"),
    (try_end),

    (assign, ":count_no", 0),
    (try_begin),
       (gt, reg0, "itm_imod_0"),
       (val_add, ":count_no", 1),
       (str_store_item_name, s0, reg0),
       (call_script, "script_store_string_number", ":count_no"),
    (try_end),
    (try_begin),
       (gt, reg1, "itm_imod_0"),
       (val_add, ":count_no", 1),
       (str_store_item_name, s0, reg1),
       (call_script, "script_store_string_number", ":count_no"),
    (try_end),
    (try_begin),
       (gt, reg2, "itm_imod_0"),
       (val_add, ":count_no", 1),
       (str_store_item_name, s0, reg2),
       (call_script, "script_store_string_number", ":count_no"),
    (try_end),
    (val_add, ":count_no", 1),
    (str_store_item_name, s0, ":item_no"),
    (call_script, "script_store_string_number", ":count_no"),
    (val_sub, ":count_no", 1),
    (val_add, ":count_no", "str_one_word_text"),
    (str_store_string, s0, ":count_no"),
    (overlay_set_text, "$g_presentation_text_1", s0),        #name with modifier

    (item_get_type, ":item_type", ":item_no"),
    (store_sub, ":string_no", ":item_type", itp_type_horse),
    (val_add, ":string_no", "str_mount"),
    (str_store_string, s1, ":string_no"),
    (overlay_set_text, "$g_presentation_text_2", s1),

    (store_item_value, reg1, ":item_no"),
    (overlay_set_text, "$g_presentation_text_3", "@{reg1}铁 币 "),

    (try_for_range, ":count_no", 0, 19),
       (store_add, ":overlay_id", ":count_no", "$g_presentation_text_4"),
       (overlay_set_display, ":overlay_id", 0),
    (try_end),

    (assign, ":cur_x", 10),
    (assign, ":cur_y", 140),
    (item_get_type, ":type_no", ":item_no"),

    (try_begin),
       (item_get_head_armor, ":return_value", ":item_no"),
       (neq, ":type_no", itp_type_goods),
       (gt, ":return_value", 0),
       (call_script, "script_item_property_modifier", 2703, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_4", "str_get_head_armor"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_4", pos1),
       (overlay_set_display, "$g_presentation_text_4", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_body_armor, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (call_script, "script_item_property_modifier", 2704, ":original_modifier_no", ":return_value"),
       (try_begin),
          (eq, ":type_no", itp_type_shield),
          (str_store_string, s1, "str_shield_protection"),
       (else_try),
          (eq, ":type_no", itp_type_horse),
          (str_store_string, s1, "str_horse_protection"),
       (else_try),
          (str_store_string, s1, "str_body_protection"),
       (try_end),
       (overlay_set_text, "$g_presentation_text_5", "str_get_body_armor"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_5", pos1),
       (overlay_set_display, "$g_presentation_text_5", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_leg_armor, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (neq, ":type_no", itp_type_bow),
       (neq, ":type_no", itp_type_crossbow),
       (neq, ":type_no", itp_type_pistol),
       (neq, ":type_no", itp_type_musket),
       (call_script, "script_item_property_modifier", 2705, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_6", "str_get_leg_armor"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_6", pos1),
       (overlay_set_display, "$g_presentation_text_6", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_hit_points, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (this_or_next|eq, ":type_no", itp_type_shield),
       (eq, ":type_no", itp_type_horse),
       (call_script, "script_item_property_modifier", 2706, ":original_modifier_no", ":return_value"),
       (try_begin),
          (eq, ":type_no", itp_type_shield),
          (str_store_string, s1, "str_shield_hp"),
       (else_try),
          (str_store_string, s1, "str_horse_hp"),
       (try_end),
       (overlay_set_text, "$g_presentation_text_7", "str_get_hit_points"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_7", pos1),
       (overlay_set_display, "$g_presentation_text_7", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_weapon_length, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (this_or_next|eq, ":type_no", itp_type_shield),
       (this_or_next|eq, ":type_no", itp_type_one_handed_wpn),
       (this_or_next|eq, ":type_no", itp_type_two_handed_wpn),
       (eq, ":type_no", itp_type_polearm),
       (call_script, "script_item_property_modifier", 2707, ":original_modifier_no", ":return_value"),
       (try_begin),
          (eq, ":type_no", itp_type_shield),
          (val_mul, reg1, 196),
          (val_div, reg1, 100),
          (overlay_set_text, "$g_presentation_text_8", "str_get_shield_length"),
       (else_try),
          (overlay_set_text, "$g_presentation_text_8", "str_get_weapon_length"),
       (try_end),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_8", pos1),
       (overlay_set_display, "$g_presentation_text_8", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_speed_rating, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (neq, ":type_no", itp_type_horse),
       (call_script, "script_item_property_modifier", 2708, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_9", "str_get_speed_rating"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_9", pos1),
       (overlay_set_display, "$g_presentation_text_9", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_missile_speed, ":return_value", ":item_no"),
       (neq, ":type_no", itp_type_horse),
       (gt, ":return_value", 0),
       (call_script, "script_item_property_modifier", 2709, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_10", "str_get_missile_speed"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_10", pos1),
       (overlay_set_display, "$g_presentation_text_10", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_max_ammo, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (call_script, "script_item_property_modifier", 2710, ":original_modifier_no", ":return_value"),
       (try_begin),
          (this_or_next|eq, ":type_no", itp_type_crossbow),
          (this_or_next|eq, ":type_no", itp_type_pistol),
          (eq, ":type_no", itp_type_musket),
          (overlay_set_text, "$g_presentation_text_11", "str_get_max_ammo_load"),
       (else_try),
          (eq, ":type_no", itp_type_goods),
          (call_script, "script_player_get_new_inventory_slot_amount", ":inventory_slot_no"),
          (assign, reg2, reg0),
          (overlay_set_text, "$g_presentation_text_11", "str_get_good_amount"),
       (else_try),
          (overlay_set_text, "$g_presentation_text_11", "str_get_max_ammo"),
       (try_end),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_11", pos1),
       (overlay_set_display, "$g_presentation_text_11", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_accuracy, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (this_or_next|eq, ":type_no", itp_type_bow),
       (this_or_next|eq, ":type_no", itp_type_crossbow),
       (this_or_next|eq, ":type_no", itp_type_pistol),
       (eq, ":type_no", itp_type_musket),
       (call_script, "script_item_property_modifier", 2711, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_12", "str_get_accuracy"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_12", pos1),
       (overlay_set_display, "$g_presentation_text_12", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_horse_scale, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (eq, ":type_no", itp_type_horse),
       (val_mul, ":return_value", 1384),
       (val_div, ":return_value", 1000),
       (store_div, reg1, ":return_value", 1000),
       (store_mod, reg2, ":return_value", 1000),
       (overlay_set_text, "$g_presentation_text_13", "str_get_horse_scale"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_13", pos1),
       (overlay_set_display, "$g_presentation_text_13", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_horse_speed, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (eq, ":type_no", itp_type_horse),
       (call_script, "script_item_property_modifier", 2714, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_14", "str_get_horse_speed"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_14", pos1),
       (overlay_set_display, "$g_presentation_text_14", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_horse_maneuver, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (eq, ":type_no", itp_type_horse),
       (call_script, "script_item_property_modifier", 2715, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_15", "str_get_horse_maneuver"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_15", pos1),
       (overlay_set_display, "$g_presentation_text_15", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_food_quality, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (eq, ":type_no", itp_type_goods),
       (call_script, "script_item_property_modifier", 2716, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_16", "str_get_food_quality"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_16", pos1),
       (overlay_set_display, "$g_presentation_text_16", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_thrust_damage, ":return_value", ":item_no"),
       (neq, ":type_no", itp_type_horse),
       (gt, ":return_value", 0),
       (call_script, "script_item_property_modifier", 2718, ":original_modifier_no", ":return_value"),
       (item_get_thrust_damage_type, ":return_value", ":item_no"),
       (store_add, ":string_no", ":return_value", "str_cut"),
       (str_store_string, s1, ":string_no"),
       (try_begin),
          (this_or_next|eq, ":type_no", itp_type_bow),
          (this_or_next|eq, ":type_no", itp_type_crossbow),
          (this_or_next|eq, ":type_no", itp_type_pistol),
          (eq, ":type_no", itp_type_musket),
          (str_store_string, s2, "str_ranged_weapon_damage"),
       (else_try),
          (eq, ":type_no", itp_type_thrown),
          (str_store_string, s2, "str_throw_damage"),
       (else_try),
          (str_store_string, s2, "str_close_combat_thrust_damage"),
       (try_end),

       (try_begin),
          (this_or_next|eq, ":type_no", itp_type_arrows),
          (this_or_next|eq, ":type_no", itp_type_bolts),
          (eq, ":type_no", itp_type_bullets),
          (overlay_set_text, "$g_presentation_text_17", "str_get_ammo_damage_increase"),
       (else_try),
          (overlay_set_text, "$g_presentation_text_17", "str_get_thrust_damage"),
       (try_end),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_17", pos1),
       (overlay_set_display, "$g_presentation_text_17", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_swing_damage, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (neq, ":type_no", itp_type_horse),
       (call_script, "script_item_property_modifier", 2720, ":original_modifier_no", ":return_value"),
       (item_get_swing_damage_type, ":return_value", ":item_no"),
       (store_add, ":string_no", ":return_value", "str_cut"),
       (str_store_string, s1, ":string_no"),
       (overlay_set_text, "$g_presentation_text_18", "str_get_swing_damage"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_18", pos1),
       (overlay_set_display, "$g_presentation_text_18", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_horse_charge_damage, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (eq, ":type_no", itp_type_horse),
       (call_script, "script_item_property_modifier", 2722, ":original_modifier_no", ":return_value"),
       (overlay_set_text, "$g_presentation_text_19", "str_get_horse_charge_damage"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_19", pos1),
       (overlay_set_display, "$g_presentation_text_19", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_difficulty, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (call_script, "script_item_property_modifier", 2702, ":original_modifier_no", ":return_value"),
       (try_begin),
          (this_or_next|eq, ":type_no", itp_type_one_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_two_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_polearm),
          (this_or_next|eq, ":type_no", itp_type_crossbow),
          (this_or_next|eq, ":type_no", itp_type_head_armor),
          (this_or_next|eq, ":type_no", itp_type_body_armor),
          (this_or_next|eq, ":type_no", itp_type_foot_armor),
          (eq, ":type_no", itp_type_hand_armor),
          (str_store_string, s1, "str_strength"),
       (else_try),
          (eq, ":type_no", itp_type_bow),
          (str_store_string, s1, "str_power_draw"),
       (else_try),
          (eq, ":type_no", itp_type_thrown),
          (str_store_string, s1, "str_power_throw"),
       (else_try),
          (eq, ":type_no", itp_type_horse),
          (str_store_string, s1, "str_riding"),
       (else_try),
          (eq, ":type_no", itp_type_shield),
          (str_store_string, s1, "str_shield"),
       (else_try),
          (eq, ":type_no", itp_type_book),
          (str_store_string, s1, "str_intelligence"),
       (try_end),
       (overlay_set_text, "$g_presentation_text_20", "str_get_difficulty"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_20", pos1),
       (overlay_set_display, "$g_presentation_text_20", 1),
       (call_script, "script_item_difficulty_check", "trp_player", "trp_player", ":inventory_slot_no"),
       (try_begin),
          (eq, reg1, 0),#cannot equip
          (overlay_set_color, "$g_presentation_text_20", 0xCC0000),
       (else_try),
          (eq, reg1, 1),#can equip
          (overlay_set_color, "$g_presentation_text_20", 0x33CC33),
       (try_end),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_weight, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (store_div, reg1, ":return_value", 1000),
       (store_mod, reg2, ":return_value", 1000),
       (overlay_set_text, "$g_presentation_text_21", "str_get_weight"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_21", pos1),
       (overlay_set_display, "$g_presentation_text_21", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_get_abundance, ":return_value", ":item_no"),
       (gt, ":return_value", 0),
       (store_sub, ":return_value", 100, ":return_value"),
       (assign, reg1, ":return_value"),
       (overlay_set_text, "$g_presentation_text_22", "str_get_abundance"),
       (position_set_x, pos1, ":cur_x"),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, "$g_presentation_text_22", pos1),
       (overlay_set_display, "$g_presentation_text_22", 1),
       (val_sub, ":cur_y", 20),
    (try_end),

    (try_begin),
       (item_has_property, ":item_no", itp_next_item_as_melee),
       (eq, ":type_no", itp_type_thrown),
       (overlay_set_display, "$g_presentation_obj_4", 1),
       (overlay_set_display, "$g_presentation_obj_5", 0),
    (else_try),
       (store_sub, ":former_item_no", ":item_no", 1),
       (item_has_property, ":former_item_no", itp_next_item_as_melee),
       (item_get_type, ":former_type_no", ":former_item_no"),
       (eq, ":former_type_no", itp_type_thrown),
       (overlay_set_display, "$g_presentation_obj_4", 0),
       (overlay_set_display, "$g_presentation_obj_5", 1),
    (else_try),
       (overlay_set_display, "$g_presentation_obj_4", 0),
       (overlay_set_display, "$g_presentation_obj_5", 0),
    (try_end),

##From here begins the item special_effects
     (call_script, "script_item_get_special_effect", ":item_no"),

##item_description
     (str_store_item_name_plural, s1, ":item_no"),
     (overlay_set_text, "$g_presentation_text_23", "@{s1}^_"),

    (assign, "$current_show_slot", ":inventory_slot_no"),

    (try_begin),
       (gt, "$g_presentation_obj_8", 0),#非场景内使用
       (eq, ":type_no", itp_type_goods),
       (item_has_property, ":item_no", itp_expendable),
       (overlay_set_display, "$g_presentation_obj_8", 1),#服用消耗品
       (try_begin),
          (this_or_next|is_between, ":item_no", "itm_inferior_dragonblood_wine", "itm_dragon_heart"),
          (eq, ":item_no", "itm_dragon_heart"),
          (overlay_set_text, "$g_presentation_obj_8", "@龙 飨 仪 式 "),
       (else_try),
          (overlay_set_text, "$g_presentation_obj_8", "@服 用 "),
       (try_end),
    (else_try),
       (gt, "$g_presentation_obj_8", 0),#非场景内使用
       (overlay_set_display, "$g_presentation_obj_8", 0),
    (try_end),
  ]),


#used in item information showing
#iutput item no
  ("item_get_special_effect", 
  [
    (store_script_param_1, ":item_no"),

    (try_for_range, ":count_no", 0, 12),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", ":count_no"),
       (position_set_x, pos1, 0),
       (position_set_y, pos1, 0),
       (overlay_set_position, ":overlay_no", pos1),
       (overlay_set_display, ":overlay_no", 0),
    (try_end),

    (position_set_x, pos1, 0),#buff
    (assign, ":cur_y", 0),
    (try_begin),
       (item_has_property, ":item_no", itp_couchable),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 0),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_can_penetrate_shield),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 1),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_bonus_against_shield),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 2),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_next_item_as_melee),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 3),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_crush_through),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 4),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_can_knock_down),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 5),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_extra_penetration),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 6),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_bonus_against_horse),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 7),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),

    (position_set_x, pos1, 35),#debuff
    (assign, ":cur_y", 0),
    (try_begin),
       (item_has_property, ":item_no", itp_cant_reload_on_horseback),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 8),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_cant_use_on_horseback),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 9),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_unbalanced),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 10),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
    (try_begin),
       (item_has_property, ":item_no", itp_cant_reload_while_moving),
       (troop_get_slot, ":overlay_no", "trp_temp_array_c", 11),
       (overlay_set_display, ":overlay_no", 1),
       (position_set_y, pos1, ":cur_y"),
       (overlay_set_position, ":overlay_no", pos1),
       (val_add, ":cur_y", 35),
    (try_end),
  ]),


#small tool
#used for player to change next weapon of right hand, in case the next weapon slot is empty.
#output item no
  ("right_hand_get_next_usable_weapon", 
  [
    (try_begin),
       (lt, "$cur_weapon_right_hand", 43),
       (agent_get_slot, ":weapon_no", "$mission_player_agent", "$cur_weapon_right_hand"),
       (try_begin),
          (ge, ":weapon_no", 1),
          (agent_get_ammo_for_slot, ":ammo_num", "$mission_player_agent", 0),
          (store_add, ":slot_no", "$cur_weapon_right_hand", 6),
          (agent_set_slot, "$mission_player_agent", ":slot_no", ":ammo_num"),
          (agent_unequip_item, "$mission_player_agent", ":weapon_no", 1),
          (try_begin),
             (item_get_type, ":type_no", ":weapon_no"),
             (eq, ":type_no", itp_type_thrown),
             (le, ":ammo_num", 0),
             (agent_set_slot, "$mission_player_agent", "$cur_weapon_right_hand", 0),#throw weapon run off.
          (try_end),
       (try_end),
       (val_add, "$cur_weapon_right_hand", 1),
    (else_try),
       (eq, "$cur_weapon_right_hand", 43),
       (agent_get_slot, ":weapon_no", "$mission_player_agent", "$cur_weapon_right_hand"),
       (try_begin),
          (ge, ":weapon_no", 1),
          (agent_get_ammo_for_slot, ":ammo_num", "$mission_player_agent", 0),
          (store_add, ":slot_no", "$cur_weapon_right_hand", 6),
          (agent_set_slot, "$mission_player_agent", ":slot_no", ":ammo_num"),
          (agent_unequip_item, "$mission_player_agent", ":weapon_no", 1),
          (try_begin),
             (item_get_type, ":type_no", ":weapon_no"),
             (eq, ":type_no", itp_type_thrown),
             (le, ":ammo_num", 0),
             (agent_set_slot, "$mission_player_agent", "$cur_weapon_right_hand", 0),#throw weapon run off.
          (try_end),
       (try_end),
       (assign, "$cur_weapon_right_hand", 41),   
    (try_end),
    (agent_get_slot, ":weapon_no", "$mission_player_agent", "$cur_weapon_right_hand"),
    (try_begin),
       (le, ":weapon_no", 0),
       (lt, "$change_weapon_try_time", 3),
       (val_add, "$change_weapon_try_time", 1),
       (call_script, "script_right_hand_get_next_usable_weapon"),
    (else_try),
       (assign, reg1, ":weapon_no"),
    (try_end),
  ]),


#small tool
#used for player to change next weapon of left hand, in case the next weapon slot is empty.
#output item no
  ("left_hand_get_next_usable_weapon", 
  [
    (try_begin),
       (lt, "$cur_weapon_left_hand", 46),
       (agent_get_slot, ":weapon_no", "$mission_player_agent", "$cur_weapon_left_hand"),
       (try_begin),
          (ge, ":weapon_no", 1),
          (try_begin),
             (item_get_type, ":type_no", ":weapon_no"),
             (eq, ":type_no", itp_type_shield),
             (store_add, ":slot_no", "$cur_weapon_left_hand", 6),
             (agent_get_slot, ":shield_hp", "$mission_player_agent", ":slot_no"),
             (le, ":shield_hp", 0),
             (agent_set_slot, "$mission_player_agent", "$cur_weapon_left_hand", 0),#shield run out of hp
          (try_end),
          (agent_unequip_item, "$mission_player_agent", ":weapon_no", 2),
       (try_end),
       (val_add, "$cur_weapon_left_hand", 1),
    (else_try),
       (eq, "$cur_weapon_left_hand", 46),
       (agent_get_slot, ":weapon_no", "$mission_player_agent", "$cur_weapon_left_hand"),
       (try_begin),
          (ge, ":weapon_no", 1),
          (try_begin),
             (item_get_type, ":type_no", ":weapon_no"),
             (eq, ":type_no", itp_type_shield),
             (store_add, ":slot_no", "$cur_weapon_left_hand", 6),
             (agent_get_slot, ":shield_hp", "$mission_player_agent", ":slot_no"),
             (le, ":shield_hp", 0),
             (agent_set_slot, "$mission_player_agent", "$cur_weapon_left_hand", 0),#shield run out of hp
          (try_end),
          (agent_unequip_item, "$mission_player_agent", ":weapon_no", 2),
       (try_end),
       (assign, "$cur_weapon_left_hand", 44),   
    (try_end),
    (agent_get_slot, ":weapon_no", "$mission_player_agent", "$cur_weapon_left_hand"),
    (try_begin),
       (le, ":weapon_no", 0),
       (lt, "$change_weapon_try_time", 3),
       (val_add, "$change_weapon_try_time", 1),
       (call_script, "script_left_hand_get_next_usable_weapon"),
    (else_try),
       (assign, reg1, ":weapon_no"),
    (try_end),
  ]),


#small tool
#check if an troop can equip certain item from anohter troop.
#input troop no, giver troop no and slot no, output 1 as having capability, and 0 as unable.
  ("item_difficulty_check", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":giver_troop_no", 2),
    (store_script_param, ":inventory_slot_no", 3),
    (assign, ":continue_no", 0),

    (try_begin),
       (eq, ":giver_troop_no", trp_player),
       (call_script, "script_player_get_new_inventory_slot", ":inventory_slot_no"),
       (assign, ":item_no", reg0),
    (else_try),
       (troop_get_inventory_slot, ":item_no", ":giver_troop_no", ":inventory_slot_no"),
    (try_end),

    (call_script, "script_troop_get_new_inventory_slot_modifier", ":giver_troop_no", ":inventory_slot_no"),#get modifier
    (assign, ":original_modifier_no", 0),
    (try_begin),
       (gt, reg0, "itm_imod_0"),
       (le, reg0, "itm_imod_42"),
       (store_sub, ":original_modifier_no", reg0, "itm_imod_0"),
    (else_try),
       (gt, reg1, "itm_imod_0"),
       (le, reg1, "itm_imod_42"),
       (store_sub, ":original_modifier_no", reg1, "itm_imod_0"),
    (else_try),
       (gt, reg2, "itm_imod_0"),
       (le, reg2, "itm_imod_42"),
       (store_sub, ":original_modifier_no", reg2, "itm_imod_0"),
    (try_end),


    (try_begin),
       (le, ":item_no", 0),
       (assign, ":continue_no", 1),
    (else_try),
       (item_get_type, ":type_no", ":item_no"),
       (item_get_difficulty, ":difficulty_num", ":item_no"),
       (call_script, "script_item_property_modifier", 2702, ":original_modifier_no", ":difficulty_num"),
       (assign, ":difficulty_num", reg1),
       (try_begin),
          (this_or_next|eq, ":type_no", itp_type_one_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_two_handed_wpn),
          (this_or_next|eq, ":type_no", itp_type_polearm),
          (this_or_next|eq, ":type_no", itp_type_crossbow),
          (this_or_next|eq, ":type_no", itp_type_head_armor),
          (this_or_next|eq, ":type_no", itp_type_body_armor),
          (this_or_next|eq, ":type_no", itp_type_foot_armor),
          (eq, ":type_no", itp_type_hand_armor),
          (store_attribute_level, ":strength_num", ":troop_no", ca_strength),
          (ge, ":strength_num", ":difficulty_num"),
          (assign, ":continue_no", 1),
       (else_try),
          (eq, ":type_no", itp_type_bow),
          (store_skill_level, ":power_draw_num", skl_power_draw, ":troop_no"),
          (ge, ":power_draw_num", ":difficulty_num"),
          (assign, ":continue_no", 1),
       (else_try),
          (eq, ":type_no", itp_type_thrown),
          (store_skill_level, ":power_throw_num", skl_power_throw, ":troop_no"),
          (ge, ":power_throw_num", ":difficulty_num"),
          (assign, ":continue_no", 1),
       (else_try),
          (eq, ":type_no", itp_type_horse),
          (store_skill_level, ":riding_num", skl_riding, ":troop_no"),
          (ge, ":riding_num", ":difficulty_num"),
          (assign, ":continue_no", 1),
       (else_try),
          (eq, ":type_no", itp_type_shield),
          (store_skill_level, ":shield_num", skl_shield, ":troop_no"),
          (ge, ":shield_num", ":difficulty_num"),
          (assign, ":continue_no", 1),
       (else_try),
          (eq, ":type_no", itp_type_book),
          (store_attribute_level, ":intelligence_num", ":troop_no", ca_intelligence),
          (ge, ":intelligence_num", ":difficulty_num"),
          (assign, ":continue_no", 1),
       (else_try),
          (this_or_next|eq, ":type_no", itp_type_arrows),
          (this_or_next|eq, ":type_no", itp_type_bolts),
          (eq, ":type_no", itp_type_bullets),
          (assign, ":continue_no", 1),
       (else_try),
          (eq, ":type_no", itp_type_goods),
          (assign, ":continue_no", 1),
       (try_end),
    (try_end),
    (assign, reg1, ":continue_no"),
  ]),


#small tool
#Used to modifier certain item, as it has certain modifier.
#input operation no and modifier no.operation is bagin from 2700 to 2722, represented 23 properties. In case script cant read operation list, we'd better input numbers .Output modifier results.
  ("item_property_modifier", 
  [
    (store_script_param, ":operation_no", 1),
    (store_script_param, ":modifier_no", 2),  
    (store_script_param, ":input_value", 3),

    (try_begin),
       (eq, ":operation_no", 2700),#weight
    (else_try),
       (eq, ":operation_no", 2701),#value
    (else_try),
       (eq, ":operation_no", 2702),#difficulty
       (try_begin),
          (eq, ":modifier_no", imod_masterwork),
          (val_add, ":input_value", 4),
       (else_try),
          (eq, ":modifier_no", imod_heavy),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_strong),
          (val_add, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_stubborn),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_timid),
          (val_sub, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_spirited),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_champion),
          (val_add, ":input_value", 2),
       (try_end),
    (else_try),
       (this_or_next|eq, ":operation_no", 2703),#head_armor
       (this_or_next|eq, ":operation_no", 2704),#body_armor
       (eq, ":operation_no", 2705),#leg_armor
       (try_begin),
          (eq, ":modifier_no", imod_cracked),
          (val_sub, ":input_value", 4),
       (else_try),
          (eq, ":modifier_no", imod_rusty),
          (val_sub, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_battered),
          (val_sub, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_crude),
          (val_sub, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_heavy),
          (val_add, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_tattered),
          (val_sub, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_ragged),
          (val_sub, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_sturdy),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_thick),
          (val_add, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_hardened),
          (val_add, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_reinforced),
          (val_add, ":input_value", 4),
       (else_try),
          (eq, ":modifier_no", imod_lordly),
          (val_add, ":input_value", 6),
       (try_end),
    (else_try),
       (eq, ":operation_no", 2706),#hit_points
       (try_begin),
          (eq, ":modifier_no", imod_cracked),
          (val_sub, ":input_value", 46),
       (else_try),
          (eq, ":modifier_no", imod_battered),
          (val_sub, ":input_value", 26),
       (else_try),
          (eq, ":modifier_no", imod_heavy),
          (val_add, ":input_value", 10),
       (else_try),
          (eq, ":modifier_no", imod_thick),
          (val_add, ":input_value", 47),
       (else_try),
          (eq, ":modifier_no", imod_reinforced),
          (val_add, ":input_value", 83),
       (else_try),
          (eq, ":modifier_no", imod_lordly),
          (val_add, ":input_value", 155),
       (else_try),
          (eq, ":modifier_no", imod_stubborn),
          (val_add, ":input_value", 5),
       (try_end),
    (else_try),
       (eq, ":operation_no", 2707),#weapon_length
    (else_try),
       (this_or_next|eq, ":operation_no", 2708),#speed_rating
       (eq, ":operation_no", 2709),#missile_speed
       (try_begin),
          (eq, ":modifier_no", imod_bent),
          (val_sub, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_balanced),
          (val_add, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_masterwork),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_heavy),
          (val_sub, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_strong),
          (val_sub, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_strong),
          (val_sub, ":input_value", 3),
       (try_end),
    (else_try),
       (eq, ":operation_no", 2710),#max_ammo
       (eq, ":modifier_no", imod_large_bag),
       (val_mul, ":input_value", 113),
       (val_div, ":input_value", 100),
    (else_try),
       (eq, ":operation_no", 2711),#accuracy
    (else_try),
       (eq, ":operation_no", 2712),#shield_height
    (else_try),
       (eq, ":operation_no", 2713),#horse_scale
    (else_try),
       (eq, ":operation_no", 2714),#horse_speed
       (try_begin),
          (eq, ":modifier_no", imod_heavy),
          (val_sub, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_lame),
          (val_sub, ":input_value", 10),
       (else_try),
          (eq, ":modifier_no", imod_swaybacked),
          (val_sub, ":input_value", 4),
       (else_try),
          (eq, ":modifier_no", imod_spirited),
          (val_add, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_champion),
          (val_add, ":input_value", 4),
       (try_end),
    (else_try),
       (eq, ":operation_no", 2715),#horse_maneuver
       (try_begin),
          (eq, ":modifier_no", imod_lame),
          (val_sub, ":input_value", 5),
       (else_try),
          (eq, ":modifier_no", imod_swaybacked),
          (val_sub, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_spirited),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_champion),
          (val_add, ":input_value", 2),
       (try_end),
    (else_try),
       (eq, ":operation_no", 2716),#food_quality
    (else_try),
       (eq, ":operation_no", 2717),#abundance
    (else_try),
       (this_or_next|eq, ":operation_no", 2718),#thrust_damage
       (eq, ":operation_no", 2720),#swing_damage
       (try_begin),
          (eq, ":modifier_no", imod_cracked),
          (val_sub, ":input_value", 5),
       (else_try),
          (eq, ":modifier_no", imod_rusty),
          (val_sub, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_bent),
          (val_sub, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_chipped),
          (val_sub, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_crude),
          (val_sub, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_fine),
          (val_sub, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_balanced),
          (val_add, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_tempered),
          (val_add, ":input_value", 4),
       (else_try),
          (eq, ":modifier_no", imod_masterwork),
          (val_add, ":input_value", 5),
       (else_try),
          (eq, ":modifier_no", imod_heavy),
          (val_add, ":input_value", 2),
       (else_try),
          (eq, ":modifier_no", imod_strong),
          (val_add, ":input_value", 3),
       (else_try),
          (eq, ":modifier_no", imod_strong),
          (val_add, ":input_value", 3),
       (try_end),
    (else_try),
       (eq, ":operation_no", 2722),#horse_damage
       (try_begin),
          (eq, ":modifier_no", imod_heavy),
          (val_add, ":input_value", 4),
       (else_try),
          (eq, ":modifier_no", imod_spirited),
          (val_add, ":input_value", 1),
       (else_try),
          (eq, ":modifier_no", imod_champion),
          (val_add, ":input_value", 2),
       (try_end),
    (try_end),
    (assign, reg1, ":input_value"),
  ]),


#important small tool
#connect string no with string slot, like s1, s2 .etc
#input count. String id or quick string should be store in s0 temperarily before the script was called
  ("store_string_number", 
  [
    (store_script_param_1, ":count_no"),
    (try_begin),
       (eq, ":count_no", 1),
       (str_store_string, s1, s0),
    (else_try),
       (eq, ":count_no", 2),
       (str_store_string, s2, s0),
    (else_try),
       (eq, ":count_no", 3),
       (str_store_string, s3, s0),
    (else_try),
       (eq, ":count_no", 4),
       (str_store_string, s4, s0),
    (else_try),
       (eq, ":count_no", 5),
       (str_store_string, s5, s0),
    (else_try),
       (eq, ":count_no", 6),
       (str_store_string, s6, s0),
    (else_try),
       (eq, ":count_no", 7),
       (str_store_string, s7, s0),
    (else_try),
       (eq, ":count_no", 8),
       (str_store_string, s8, s0),
    (else_try),
       (eq, ":count_no", 9),
       (str_store_string, s9, s0),
    (else_try),
       (eq, ":count_no", 10),
       (str_store_string, s10, s0),
    (else_try),
       (eq, ":count_no", 11),
       (str_store_string, s1, s0),
    (else_try),
       (eq, ":count_no", 12),
       (str_store_string, s12, s0),
    (else_try),
       (eq, ":count_no", 13),
       (str_store_string, s13, s0),
    (else_try),
       (eq, ":count_no", 14),
       (str_store_string, s14, s0),
    (else_try),
       (eq, ":count_no", 15),
       (str_store_string, s15, s0),
    (else_try),
       (eq, ":count_no", 16),
       (str_store_string, s16, s0),
    (else_try),
       (eq, ":count_no", 17),
       (str_store_string, s17, s0),
    (else_try),
       (eq, ":count_no", 18),
       (str_store_string, s18, s0),
    (else_try),
       (eq, ":count_no", 19),
       (str_store_string, s19, s0),
    (else_try),
       (eq, ":count_no", 20),
       (str_store_string, s20, s0),
    (else_try),
       (eq, ":count_no", 21),
       (str_store_string, s21, s0),
    (else_try),
       (eq, ":count_no", 22),
       (str_store_string, s22, s0),
    (else_try),
       (eq, ":count_no", 23),
       (str_store_string, s23, s0),
    (else_try),
       (eq, ":count_no", 24),
       (str_store_string, s24, s0),
    (else_try),
       (eq, ":count_no", 25),
       (str_store_string, s25, s0),
    (else_try),
       (eq, ":count_no", 26),
       (str_store_string, s26, s0),
    (else_try),
       (eq, ":count_no", 27),
       (str_store_string, s27, s0),
    (else_try),
       (eq, ":count_no", 28),
       (str_store_string, s28, s0),
    (else_try),
       (eq, ":count_no", 29),
       (str_store_string, s29, s0),
    (else_try),
       (eq, ":count_no", 31),
       (str_store_string, s31, s0),
    (else_try),
       (eq, ":count_no", 32),
       (str_store_string, s32, s0),
    (else_try),
       (eq, ":count_no", 33),
       (str_store_string, s33, s0),
    (else_try),
       (eq, ":count_no", 34),
       (str_store_string, s34, s0),
    (else_try),
       (eq, ":count_no", 35),
       (str_store_string, s35, s0),
    (else_try),
       (eq, ":count_no", 36),
       (str_store_string, s36, s0),
    (else_try),
       (eq, ":count_no", 37),
       (str_store_string, s37, s0),
    (else_try),
       (eq, ":count_no", 38),
       (str_store_string, s38, s0),
    (else_try),
       (eq, ":count_no", 39),
       (str_store_string, s39, s0),
    (try_end),
  ]),


#important small tool
#As there are no operations to measured agent's shield hp, neither can we catch the point when a shield is destroyed, so I wirte this script to count shield hp renewedly and independently. Hp will be store in three agent slot.
#input defender agent no, damage number and shield item no come from item triggers. If necessary in the future, attcker agent no and missile item kind (if being hit by ranged weapon) can also be gotten.
  ("shield_technique", 
  [
    (store_script_param, ":defender_agent_no", 1),
    (store_script_param, ":damage_count", 2),
    (store_script_param, ":shield_item_no", 3),

    (try_begin),
       (eq, ":defender_agent_no", "$mission_player_agent"),
       (neg|item_has_property, ":shield_item_no", itp_left_hand_weapon),#左手武器无耐久
       (store_add, ":slot_no", "$cur_weapon_left_hand", 6),
       (agent_get_slot, ":shield_hp", "$mission_player_agent", ":slot_no"),
       (val_sub, ":shield_hp", ":damage_count"),
       (agent_set_slot, "$mission_player_agent", ":slot_no", ":shield_hp"),
       (try_begin),
          (le, ":shield_hp", 0),
          (agent_unequip_item, "$mission_player_agent", ":shield_item_no"),
          (display_message, "@盾 牌 破 了 ！ "),
          (agent_play_sound, "$mission_player_agent", "snd_shield_broken"),
          (agent_set_slot, "$mission_player_agent", "$cur_weapon_left_hand", -1),
          (store_add, ":modifier_slot_no", "$cur_weapon_left_hand", 12),
          (agent_set_slot, "$mission_player_agent", ":modifier_slot_no", -1),#modifier
       (try_end),
    (try_end),

    (try_begin),
       (item_has_property, ":shield_item_no", itp_left_hand_weapon),#左手武器无耐久
       (assign, ":damage_count", 0),
    (try_end),
    (assign, reg1, ":damage_count"),
  ]),

#important small tool
#检查饰物是否装备。玩家检查是否装备在16到20位。
  ("check_accessorise_equipped", 
  [
    (store_script_param, ":troop_no", 1),
    (store_script_param, ":accessorise_item_no", 2),
    (assign, ":count_no", 0),
    (try_begin),
       (eq, ":troop_no", "trp_player"),
       (player_has_item, ":accessorise_item_no"),
       (assign, ":limit_no", ek_small_tool_1),
       (try_for_range, ":slot_no", ek_accessorise_1, ":limit_no"),
          (troop_get_inventory_slot, ":if_have_item", "trp_player", ":slot_no"),
          (eq, ":if_have_item", ":accessorise_item_no"),
          (assign, ":count_no", 1),
          (assign, ":limit_no", 0),#break
       (try_end),
    (try_end),
    (assign, reg1, ":count_no"),
  ]),




]